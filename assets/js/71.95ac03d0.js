(window.webpackJsonp=window.webpackJsonp||[]).push([[71],{1325:function(s,t,a){"use strict";a.r(t);var n=a(3),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"scrapy模拟登陆"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#scrapy模拟登陆"}},[s._v("#")]),s._v(" scrapy模拟登陆")]),s._v(" "),a("h5",{attrs:{id:"学习目标"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#学习目标"}},[s._v("#")]),s._v(" 学习目标：")]),s._v(" "),a("ol",[a("li",[s._v("应用 请求对象cookies参数的使用")]),s._v(" "),a("li",[s._v("了解 start_requests函数的作用")]),s._v(" "),a("li",[s._v("应用 构造并发送post请求")])]),s._v(" "),a("hr"),s._v(" "),a("h3",{attrs:{id:"_1-回顾之前的模拟登陆的方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-回顾之前的模拟登陆的方法"}},[s._v("#")]),s._v(" 1. 回顾之前的模拟登陆的方法")]),s._v(" "),a("h4",{attrs:{id:"_1-1-requests模块是如何实现模拟登陆的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-requests模块是如何实现模拟登陆的"}},[s._v("#")]),s._v(" 1.1 requests模块是如何实现模拟登陆的？")]),s._v(" "),a("ol",[a("li",[s._v("直接携带cookies请求页面")]),s._v(" "),a("li",[s._v("找url地址，发送post请求存储cookie")])]),s._v(" "),a("h4",{attrs:{id:"_1-2-selenium是如何模拟登陆的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-selenium是如何模拟登陆的"}},[s._v("#")]),s._v(" 1.2 selenium是如何模拟登陆的？")]),s._v(" "),a("ol",[a("li",[s._v("找到对应的input标签，输入文本点击登陆")])]),s._v(" "),a("h4",{attrs:{id:"_1-3-scrapy的模拟登陆"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-scrapy的模拟登陆"}},[s._v("#")]),s._v(" 1.3 scrapy的模拟登陆")]),s._v(" "),a("ol",[a("li",[s._v("直接携带cookies")]),s._v(" "),a("li",[s._v("找url地址，发送post请求存储cookie")])]),s._v(" "),a("h3",{attrs:{id:"_2-scrapy携带cookies直接获取需要登陆后的页面"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-scrapy携带cookies直接获取需要登陆后的页面"}},[s._v("#")]),s._v(" 2. scrapy携带cookies直接获取需要登陆后的页面")]),s._v(" "),a("h5",{attrs:{id:"应用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#应用场景"}},[s._v("#")]),s._v(" 应用场景")]),s._v(" "),a("ol",[a("li",[s._v("cookie过期时间很长，常见于一些不规范的网站")]),s._v(" "),a("li",[s._v("能在cookie过期之前把所有的数据拿到")]),s._v(" "),a("li",[s._v("配合其他程序使用，比如其使用selenium把登陆之后的cookie获取到保存到本地，scrapy发送请求之前先读取本地cookie")])]),s._v(" "),a("h4",{attrs:{id:"_2-1-实现-重构scrapy的starte-rquests方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-实现-重构scrapy的starte-rquests方法"}},[s._v("#")]),s._v(" 2.1 实现：重构scrapy的starte_rquests方法")]),s._v(" "),a("p",[s._v("scrapy中start_url是通过start_requests来进行处理的，其实现代码如下")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('# 这是源代码\ndef start_requests(self):\n    cls = self.__class__\n    if method_is_overridden(cls, Spider, \'make_requests_from_url\'):\n        warnings.warn(\n            "Spider.make_requests_from_url method is deprecated; it "\n            "won\'t be called in future Scrapy releases. Please "\n            "override Spider.start_requests method instead (see %s.%s)." % (\n                cls.__module__, cls.__name__\n            ),\n        )\n        for url in self.start_urls:\n            yield self.make_requests_from_url(url)\n    else:\n        for url in self.start_urls:\n            yield Request(url, dont_filter=True)\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[a("strong",[s._v("所以对应的，如果start_url地址中的url是需要登录后才能访问的url地址，则需要重写start_request方法并在其中手动添加上cookie")])]),s._v(" "),a("h4",{attrs:{id:"_2-2-携带cookies登陆github"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-携带cookies登陆github"}},[s._v("#")]),s._v(" 2.2 携带cookies登陆github")]),s._v(" "),a("blockquote",[a("p",[s._v("测试账号 noobpythoner zhoudawei123")])]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" scrapy\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" re\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Login1Spider")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("scrapy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Spider"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'login1'")]),s._v("\n    allowed_domains "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'github.com'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    start_urls "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'https://github.com/NoobPythoner'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这是一个需要登陆以后才能访问的页面")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("start_requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重构start_requests方法")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这个cookies_str是抓包获取的")]),s._v("\n        cookies_str "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'...'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 抓包获取")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将cookies_str转换为cookies_dict")]),s._v("\n        cookies_dict "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'='")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'='")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" cookies_str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'; '")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("yield")]),s._v(" scrapy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n            self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("start_urls"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            callback"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("parse"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            cookies"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("cookies_dict\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("parse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通过正则表达式匹配用户名来验证是否登陆成功")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 正则匹配的是github的用户名")]),s._v("\n        result_list "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" re"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("findall"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("r'noobpythoner|NoobPythoner'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("decode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("result_list"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("pass")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("h5",{attrs:{id:"注意"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注意"}},[s._v("#")]),s._v(" 注意：")]),s._v(" "),a("ol",[a("li",[s._v("scrapy中cookie不能够放在headers中，在构造请求的时候有专门的cookies参数，能够接受字典形式的coookie")]),s._v(" "),a("li",[s._v("在setting中设置ROBOTS协议、USER_AGENT")])]),s._v(" "),a("h3",{attrs:{id:"_3-scrapy-request发送post请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-scrapy-request发送post请求"}},[s._v("#")]),s._v(" 3. scrapy.Request发送post请求")]),s._v(" "),a("blockquote",[a("p",[s._v("我们知道可以通过scrapy.Request()指定method、body参数来发送post请求；但是通常使用scrapy.FormRequest()来发送post请求")])]),s._v(" "),a("h4",{attrs:{id:"_3-1-发送post请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-发送post请求"}},[s._v("#")]),s._v(" 3.1 发送post请求")]),s._v(" "),a("blockquote",[a("p",[s._v("注意：scrapy.FormRequest()能够发送表单和ajax请求，参考阅读 https://www.jb51.net/article/146769.htm")])]),s._v(" "),a("h5",{attrs:{id:"_3-1-1-思路分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-1-思路分析"}},[s._v("#")]),s._v(" 3.1.1 思路分析")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("找到post的url地址：点击登录按钮进行抓包，然后定位url地址为https://github.com/session")])]),s._v(" "),a("li",[a("p",[s._v("找到请求体的规律：分析post请求的请求体，其中包含的参数均在前一次的响应中")])]),s._v(" "),a("li",[a("p",[s._v("否登录成功：通过请求个人主页，观察是否包含用户名")])])]),s._v(" "),a("h5",{attrs:{id:"_3-1-2-代码实现如下"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-2-代码实现如下"}},[s._v("#")]),s._v(" 3.1.2 代码实现如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('import scrapy\nimport re\n\nclass Login2Spider(scrapy.Spider):\n   name = \'login2\'\n   allowed_domains = [\'github.com\']\n   start_urls = [\'https://github.com/login\']\n\n   def parse(self, response):\n       authenticity_token = response.xpath("//input[@name=\'authenticity_token\']/@value").extract_first()\n       utf8 = response.xpath("//input[@name=\'utf8\']/@value").extract_first()\n       commit = response.xpath("//input[@name=\'commit\']/@value").extract_first()\n        \n        #构造POST请求，传递给引擎\n       yield scrapy.FormRequest(\n           "https://github.com/session",\n           formdata={\n               "authenticity_token":authenticity_token,\n               "utf8":utf8,\n               "commit":commit,\n               "login":"noobpythoner",\n               "password":"***"\n           },\n           callback=self.parse_login\n       )\n\n   def parse_login(self,response):\n       ret = re.findall(r"noobpythoner|NoobPythoner",response.text)\n       print(ret)\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("h5",{attrs:{id:"小技巧"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小技巧"}},[s._v("#")]),s._v(" 小技巧")]),s._v(" "),a("blockquote",[a("p",[s._v("在settings.py中通过设置COOKIES_DEBUG=TRUE 能够在终端看到cookie的传递传递过程")])]),s._v(" "),a("hr"),s._v(" "),a("h2",{attrs:{id:"小结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[s._v("#")]),s._v(" 小结")]),s._v(" "),a("ol",[a("li",[s._v("start_urls中的url地址是交给start_request处理的，如有必要，可以重写start_request函数")]),s._v(" "),a("li",[s._v("直接携带cookie登陆：cookie只能传递给cookies参数接收")]),s._v(" "),a("li",[s._v("scrapy.Request()发送post请求")])]),s._v(" "),a("hr")])}),[],!1,null,null,null);t.default=e.exports}}]);